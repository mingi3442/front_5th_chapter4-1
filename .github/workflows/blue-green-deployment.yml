# .github/workflows/blue-green-deployment.yml
name: Blue-Green Deployment to AWS

# ë°°í¬ íŠ¸ë¦¬ê±°: main ë¸Œëœì¹˜(prod) ë˜ëŠ” develop ë¸Œëœì¹˜(dev)ì— push ì‹œ ì‹¤í–‰
on:
  push:
    branches:
      - main # í”„ë¡œë•ì…˜ í™˜ê²½ ë°°í¬ (prod.min73.dev)
      - develop # ê°œë°œ í™˜ê²½ ë°°í¬ (dev.min71.dev)
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. npm ì˜ì¡´ì„± ì„¤ì¹˜ (package-lock.json ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•œ ë²„ì „ ì„¤ì¹˜)
      - name: Install dependencies
        run: npm ci

      # 3. Next.js í”„ë¡œì íŠ¸ ë¹Œë“œ (ì •ì  íŒŒì¼ ìƒì„±)
      - name: Build Next.js project
        run: npm run build

      # 4. ë¸Œëœì¹˜ì— ë”°ë¼ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (main=prod, develop=dev)
      - name: Set environment variables based on branch
        id: env
        run: |
          if [[ ${{ github.ref }} == 'refs/heads/main' ]]; then
            # main ë¸Œëœì¹˜ë©´ í”„ë¡œë•ì…˜ í™˜ê²½ (prod.min73.dev)
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "distribution_id=${{ secrets.PRODUCTION_DISTRIBUTION_ID }}" >> $GITHUB_OUTPUT
            echo "domain=prod.min71.dev" >> $GITHUB_OUTPUT
          else
            # develop ë¸Œëœì¹˜ë©´ ê°œë°œ í™˜ê²½ (dev.min71.dev)
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "distribution_id=${{ secrets.DEV_DISTRIBUTION_ID }}" >> $GITHUB_OUTPUT
            echo "domain=dev.min71.dev" >> $GITHUB_OUTPUT
          fi

      # 5. AWS ìê²©ì¦ëª… ì„¤ì • (S3, CloudFront ì ‘ê·¼ì„ ìœ„í•´ í•„ìš”)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 6. í˜„ì¬ í™œì„±í™”ëœ í™˜ê²½ í™•ì¸ í›„ ë°˜ëŒ€ í™˜ê²½ìœ¼ë¡œ ë°°í¬ íƒ€ê²Ÿ ì„¤ì •
      - name: Determine target environment for Blue-Green deployment
        id: target
        run: |
          # CloudFrontì—ì„œ í˜„ì¬ Origin ë„ë©”ì¸ í™•ì¸
          CURRENT_ORIGIN=$(aws cloudfront get-distribution --id ${{ steps.env.outputs.distribution_id }} --query 'Distribution.DistributionConfig.Origins.Items[0].DomainName' --output text)
          echo "Current active origin: $CURRENT_ORIGIN"

          # í˜„ì¬ê°€ blueë©´ greenìœ¼ë¡œ, greenì´ë©´ blueë¡œ íƒ€ê²Ÿ ì„¤ì •
          if [[ $CURRENT_ORIGIN == *"blue"* ]]; then
            TARGET="green"
            echo "ğŸ”µ Current: BLUE â†’ ğŸ¯ Deploying to: GREEN"
          else
            TARGET="blue"
            echo "ğŸŸ¢ Current: GREEN â†’ ğŸ¯ Deploying to: BLUE"
          fi

          # ë‹¤ìŒ ìŠ¤í…ì—ì„œ ì‚¬ìš©í•  ë³€ìˆ˜ë“¤ ì„¤ì •
          echo "target_color=$TARGET" >> $GITHUB_OUTPUT
          echo "target_bucket=hanghae-${{ steps.env.outputs.environment }}-$TARGET" >> $GITHUB_OUTPUT

      # 7. ë¹Œë“œëœ íŒŒì¼ì„ íƒ€ê²Ÿ S3 ë²„í‚·ì— ì—…ë¡œë“œ
      - name: Deploy to target S3 bucket
        run: |
          echo "ğŸ“¤ Deploying to S3 bucket: ${{ steps.target.outputs.target_bucket }}"
          echo "ğŸ¯ Target domain: ${{ steps.env.outputs.domain }}"
          # out/ í´ë”ì˜ ëª¨ë“  íŒŒì¼ì„ S3ì— ë™ê¸°í™” (ê¸°ì¡´ íŒŒì¼ ì‚­ì œ í›„ ìƒˆ íŒŒì¼ ì—…ë¡œë“œ)
          aws s3 sync out/ s3://${{ steps.target.outputs.target_bucket }} --delete

      # 8. ë°°í¬ëœ í™˜ê²½ì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€ í—¬ìŠ¤ì²´í¬
      - name: Health check on deployed environment
        run: |
          # S3 ì •ì  ì›¹ì‚¬ì´íŠ¸ ì—”ë“œí¬ì¸íŠ¸ë¡œ í—¬ìŠ¤ì²´í¬
          HEALTH_URL="https://${{ steps.target.outputs.target_bucket }}.s3.amazonaws.com/index.html"
          echo "ğŸ¥ Health checking: $HEALTH_URL"

          # HTTP ìš”ì²­ì´ ì„±ê³µí•˜ë©´ ë°°í¬ ì„±ê³µìœ¼ë¡œ íŒë‹¨
          if curl -f --max-time 30 "$HEALTH_URL"; then
            echo "âœ… Health check passed - deployment is healthy"
          else
            echo "âŒ Health check failed - rolling back deployment"
            exit 1  # ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨
          fi

      # 9. CloudFront Originì„ ìƒˆë¡œ ë°°í¬ëœ í™˜ê²½ìœ¼ë¡œ ìŠ¤ìœ„ì¹­
      - name: Switch CloudFront origin to new environment
        run: |
          echo "ğŸ”„ Switching CloudFront origin to ${{ steps.target.outputs.target_color }} environment"
          echo "ğŸŒ This will update: https://${{ steps.env.outputs.domain }}"

          # í˜„ì¬ CloudFront ë°°í¬ ì„¤ì • JSON íŒŒì¼ë¡œ ì €ì¥
          aws cloudfront get-distribution --id ${{ steps.env.outputs.distribution_id }} > distribution.json

          # ETag ì¶”ì¶œ (CloudFront ì—…ë°ì´íŠ¸ ì‹œ í•„ìˆ˜)
          ETAG=$(jq -r '.ETag' distribution.json)
          echo "ğŸ“‹ Current ETag: $ETAG"

          # Origin ë„ë©”ì¸ì„ ìƒˆ íƒ€ê²Ÿ ë²„í‚·ìœ¼ë¡œ ë³€ê²½
          NEW_DOMAIN="${{ steps.target.outputs.target_bucket }}.s3.amazonaws.com"
          echo "ğŸ¯ New origin domain: $NEW_DOMAIN"

          # JSON ì„¤ì •ì—ì„œ Origin ë„ë©”ì¸ ì—…ë°ì´íŠ¸ í›„ ìƒˆ ì„¤ì • íŒŒì¼ ìƒì„±
          jq --arg domain "$NEW_DOMAIN" \
             '.Distribution.DistributionConfig.Origins.Items[0].DomainName = $domain' \
             distribution.json | \
             jq '.Distribution.DistributionConfig' > updated-config.json

          # CloudFront ë°°í¬ ì„¤ì • ì—…ë°ì´íŠ¸ (ETagë¡œ ë™ì‹œì„± ì œì–´)
          aws cloudfront update-distribution \
            --id ${{ steps.env.outputs.distribution_id }} \
            --distribution-config file://updated-config.json \
            --if-match $ETAG

      # 10. CloudFront ìºì‹œ ë¬´íš¨í™” (ìƒˆ íŒŒì¼ë“¤ì´ ì¦‰ì‹œ ë°˜ì˜ë˜ë„ë¡)
      - name: Invalidate CloudFront cache
        run: |
          echo "ğŸ—‘ï¸ Invalidating CloudFront cache for immediate updates"
          echo "ğŸŒ Cache invalidation for: https://${{ steps.env.outputs.domain }}"
          # ëª¨ë“  ê²½ë¡œ(/*) ìºì‹œ ë¬´íš¨í™”
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.env.outputs.distribution_id }} \
            --paths "/*"

      # 11. ë°°í¬ ì™„ë£Œ ìš”ì•½ ì •ë³´ ì¶œë ¥
      - name: Display deployment summary
        run: |
          echo "ğŸ‰ Blue-Green deployment completed successfully!"
          echo "ğŸ“Š Deployment Summary:"
          echo "  - Environment: ${{ steps.env.outputs.environment }}"
          echo "  - Target Color: ${{ steps.target.outputs.target_color }}"
          echo "  - S3 Bucket: ${{ steps.target.outputs.target_bucket }}"
          echo "  - CloudFront ID: ${{ steps.env.outputs.distribution_id }}"
          echo "  - ğŸŒ Live URL: https://${{ steps.env.outputs.domain }}"
          echo ""
          echo "â³ Note: CloudFront propagation may take 5-15 minutes"
          echo "ğŸ”— Direct S3 URL (for testing): https://${{ steps.target.outputs.target_bucket }}.s3.amazonaws.com"
