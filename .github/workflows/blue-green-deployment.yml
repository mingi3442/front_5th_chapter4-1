name: Blue-Green Deployment with Enhanced Testing

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Code quality check (Lint)
        run: |
          echo "ğŸ” Running code quality check..."

          # ë¦°íŒ… ì‹¤í–‰ (ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆëŠ” ê²½ìš°ë§Œ)
          if [ -f "package.json" ] && npm run | grep -q "lint"; then
            echo "Running ESLint..."
            npm run lint
            echo "âœ… Linting passed"
          else
            echo "â„¹ï¸ No lint script found, skipping linting..."
          fi

      - name: Build Next.js project
        run: npm run build

      - name: Setup AWS CLI and credentials
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
        run: |
          # AWS CLIëŠ” GitHub ëŸ¬ë„ˆì— ê¸°ë³¸ ì„¤ì¹˜ë˜ì–´ ìˆìŒ
          aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY" 
          aws configure set default.region "$AWS_DEFAULT_REGION"

          # ì—°ê²° í…ŒìŠ¤íŠ¸
          aws sts get-caller-identity

      - name: Install required tools
        run: |
          sudo apt-get update && sudo apt-get install -y jq bc
          # Lighthouse CLI ì„¤ì¹˜
          npm install -g @lhci/cli lighthouse

      - name: Determine target environment (Blue/Green)
        id: target
        run: |
          # prod í™˜ê²½ì˜ í˜„ì¬ Origin í™•ì¸
          CURRENT_ORIGIN=$(aws cloudfront get-distribution --id ${{ secrets.PRODUCTION_DISTRIBUTION_ID }} --query 'Distribution.DistributionConfig.Origins.Items[0].DomainName' --output text)
          echo "Current origin: $CURRENT_ORIGIN"

          # blue/green íŒë‹¨
          if [[ $CURRENT_ORIGIN == *"blue"* ]]; then
            TARGET="green"
            CURRENT="blue"
            echo "ğŸ”µ Current: BLUE â†’ ğŸ¯ Target: GREEN"
          else
            TARGET="blue"
            CURRENT="green" 
            echo "ğŸŸ¢ Current: GREEN â†’ ğŸ¯ Target: BLUE"
          fi

          echo "target_color=$TARGET" >> $GITHUB_OUTPUT
          echo "target_bucket=hanghae-prod-$TARGET" >> $GITHUB_OUTPUT
          echo "current_color=$CURRENT" >> $GITHUB_OUTPUT
          echo "current_bucket=hanghae-prod-$CURRENT" >> $GITHUB_OUTPUT

      - name: Deploy to target S3 bucket
        run: |
          echo "ğŸ“¤ Deploying to: ${{ steps.target.outputs.target_bucket }}"

          # S3 ë²„í‚·ì— í¼ë¸”ë¦­ ì½ê¸° ê¶Œí•œ ì„¤ì • (CloudFront ì ‘ê·¼ìš©)
          echo "ğŸ”’ Setting bucket policy for CloudFront access..."
          cat > bucket-policy.json << EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "PublicReadGetObject",
                "Effect": "Allow",
                "Principal": "*",
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::${{ steps.target.outputs.target_bucket }}/*"
              }
            ]
          }
          EOF

          aws s3api put-bucket-policy \
            --bucket ${{ steps.target.outputs.target_bucket }} \
            --policy file://bucket-policy.json

          # S3 íŒŒì¼ ì—…ë¡œë“œ
          aws s3 sync out/ s3://${{ steps.target.outputs.target_bucket }} --delete

          echo "âœ… Deployment completed with public read access"

      - name: Health check
        run: |
          HEALTH_URL="https://${{ steps.target.outputs.target_bucket }}.s3.amazonaws.com/index.html"
          echo "ğŸ¥ Health checking: $HEALTH_URL"

          if curl -f --max-time 30 "$HEALTH_URL"; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            exit 1
          fi

      - name: Switch CloudFront origin
        id: switch
        run: |
          echo "ğŸ”„ Switching to ${{ steps.target.outputs.target_color }}"

          # í˜„ì¬ ì„¤ì • ê°€ì ¸ì˜¤ê¸° (ë¡¤ë°±ìš© ë°±ì—…)
          aws cloudfront get-distribution --id ${{ secrets.PRODUCTION_DISTRIBUTION_ID }} > dist.json
          ETAG=$(jq -r '.ETag' dist.json)

          # ë¡¤ë°±ì„ ìœ„í•´ í˜„ì¬ ì„¤ì • ì €ì¥
          echo "etag=$ETAG" >> $GITHUB_OUTPUT

          # Origin ë³€ê²½
          NEW_DOMAIN="${{ steps.target.outputs.target_bucket }}.s3.amazonaws.com"
          jq --arg domain "$NEW_DOMAIN" '.Distribution.DistributionConfig.Origins.Items[0].DomainName = $domain' dist.json | jq '.Distribution.DistributionConfig' > new-config.json

          # ì—…ë°ì´íŠ¸
          aws cloudfront update-distribution \
            --id ${{ secrets.PRODUCTION_DISTRIBUTION_ID }} \
            --distribution-config file://new-config.json \
            --if-match $ETAG

          echo "âœ… CloudFront origin switched to: $NEW_DOMAIN"

      - name: Wait for CloudFront deployment
        run: |
          echo "â³ Waiting for CloudFront deployment..."

          # CloudFront ë°°í¬ ì™„ë£Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 10ë¶„)
          for i in {1..20}; do
            STATUS=$(aws cloudfront get-distribution --id ${{ secrets.PRODUCTION_DISTRIBUTION_ID }} --query 'Distribution.Status' --output text)
            echo "Deployment status ($i/20): $STATUS"
            
            if [[ "$STATUS" == "Deployed" ]]; then
              echo "âœ… CloudFront deployment completed"
              break
            fi
            
            if [[ $i -eq 20 ]]; then
              echo "âŒ CloudFront deployment timed out"
              exit 1
            fi
            
            sleep 30
          done

          # ì¶”ê°€ ëŒ€ê¸° ì‹œê°„ (ì „íŒŒ ì™„ë£Œë¥¼ ìœ„í•´)
          echo "â³ Additional wait for propagation..."
          sleep 120

      - name: Invalidate CloudFront cache
        run: |
          echo "ğŸ”„ Invalidating CloudFront cache..."

          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.PRODUCTION_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)

          echo "Invalidation ID: $INVALIDATION_ID"
          echo "â³ Waiting for cache invalidation to complete..."

          # ìºì‹œ ë¬´íš¨í™” ì™„ë£Œ ëŒ€ê¸°
          for i in {1..10}; do
            STATUS=$(aws cloudfront get-invalidation \
              --distribution-id ${{ secrets.PRODUCTION_DISTRIBUTION_ID }} \
              --id $INVALIDATION_ID \
              --query 'Invalidation.Status' \
              --output text)
            
            echo "Invalidation status ($i/10): $STATUS"
            
            if [[ "$STATUS" == "Completed" ]]; then
              echo "âœ… Cache invalidation completed"
              break
            fi
            
            sleep 30
          done

      - name: Production health check
        run: |
          echo "ğŸ¥ Running production health checks..."
          PROD_URL="https://prod.min71.dev"

          # í”„ë¡œë•ì…˜ URL ì—°ê²° í™•ì¸
          for i in {1..5}; do
            if curl -f --max-time 30 "$PROD_URL/" > /dev/null; then
              echo "âœ… Production health check passed (attempt $i)"
              break
            else
              echo "â³ Production health check failed, retrying... (attempt $i/5)"
              if [[ $i -eq 5 ]]; then
                echo "âŒ Production health check failed"
                exit 1
              fi
              sleep 10
            fi
          done

      - name: HTML rendering validation
        run: |
          echo "ğŸ” Validating HTML rendering..."
          PROD_URL="https://prod.min71.dev"

          # HTML ì‘ë‹µ ê°€ì ¸ì˜¤ê¸°
          RESPONSE=$(curl -s "$PROD_URL/")

          # ê¸°ë³¸ HTML êµ¬ì¡° í™•ì¸
          if [[ ! $RESPONSE == *"<html"* ]] || [[ ! $RESPONSE == *"</html>"* ]]; then
            echo "âŒ Invalid HTML structure"
            exit 1
          fi

          # í•„ìˆ˜ ìš”ì†Œ í™•ì¸
          if [[ ! $RESPONSE == *"<title>"* ]]; then
            echo "âŒ Missing title tag"
            exit 1
          fi

          if [[ ! $RESPONSE == *"<head>"* ]] || [[ ! $RESPONSE == *"</head>"* ]]; then
            echo "âŒ Missing head section"
            exit 1
          fi

          # Next.js ê´€ë ¨ ìš”ì†Œ í™•ì¸
          if [[ $RESPONSE == *"_next"* ]]; then
            echo "âœ… Next.js assets detected"
          fi

          # í˜ì´ì§€ í¬ê¸° í™•ì¸
          PAGE_SIZE=$(echo -n "$RESPONSE" | wc -c)
          echo "Page size: $PAGE_SIZE bytes"

          if [ $PAGE_SIZE -lt 100 ]; then
            echo "âŒ Page too small, possible error page"
            exit 1
          fi

          echo "âœ… HTML rendering validation passed"

      - name: Lighthouse performance audit
        run: |
          echo "ğŸ” Running Lighthouse performance audit..."
          PROD_URL="https://prod.min71.dev"

          # Lighthouse ì‹¤í–‰
          lighthouse "$PROD_URL" \
            --output=json \
            --output-path=./lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
            --quiet \
            --max-wait-for-load=30000

          # ì„±ëŠ¥ ì ìˆ˜ í™•ì¸
          PERFORMANCE_SCORE=$(jq -r '.categories.performance.score * 100' lighthouse-report.json)
          ACCESSIBILITY_SCORE=$(jq -r '.categories.accessibility.score * 100' lighthouse-report.json)
          BEST_PRACTICES_SCORE=$(jq -r '.categories["best-practices"].score * 100' lighthouse-report.json)
          SEO_SCORE=$(jq -r '.categories.seo.score * 100' lighthouse-report.json)

          echo "ğŸ“Š Lighthouse Scores:"
          echo "  Performance: $PERFORMANCE_SCORE"
          echo "  Accessibility: $ACCESSIBILITY_SCORE"  
          echo "  Best Practices: $BEST_PRACTICES_SCORE"
          echo "  SEO: $SEO_SCORE"

          # ìµœì†Œ ì„±ëŠ¥ ì ìˆ˜ í™•ì¸ (60ì  ì´ìƒ)
          if (( $(echo "$PERFORMANCE_SCORE < 60" | bc -l) )); then
            echo "âš ï¸ Performance score below threshold: $PERFORMANCE_SCORE (minimum: 60)"
            echo "ğŸ”„ Deployment will continue but performance needs attention"
          else
            echo "âœ… Performance score acceptable: $PERFORMANCE_SCORE"
          fi

          # ì ‘ê·¼ì„± ì ìˆ˜ í™•ì¸ (80ì  ì´ìƒ)
          if (( $(echo "$ACCESSIBILITY_SCORE < 80" | bc -l) )); then
            echo "âš ï¸ Accessibility score below recommended: $ACCESSIBILITY_SCORE"
          else
            echo "âœ… Accessibility score good: $ACCESSIBILITY_SCORE"
          fi

      - name: Final stability test
        run: |
          echo "ğŸ” Running final stability test..."
          PROD_URL="https://prod.min71.dev"

          # 1ë¶„ê°„ ì•ˆì •ì„± í…ŒìŠ¤íŠ¸
          for i in {1..4}; do
            if ! curl -f --max-time 15 "$PROD_URL/" > /dev/null; then
              echo "âŒ Stability test failed at check $i"
              exit 1
            fi
            echo "âœ… Stability check $i/4 passed"
            sleep 15
          done

          echo "âœ… Final stability test completed"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "ğŸš¨ Deployment failed! Initiating rollback..."

          if [[ -f "dist.json" ]] && [[ -n "${{ steps.switch.outputs.etag }}" ]]; then
            echo "ğŸ”„ Rolling back CloudFront to previous configuration..."
            
            # ì›ë˜ ì„¤ì •ìœ¼ë¡œ ë¡¤ë°±
            jq '.Distribution.DistributionConfig' dist.json > rollback-config.json
            
            # ìƒˆë¡œìš´ ETag ê°€ì ¸ì˜¤ê¸°
            CURRENT_ETAG=$(aws cloudfront get-distribution --id ${{ secrets.PRODUCTION_DISTRIBUTION_ID }} --query 'ETag' --output text)
            
            aws cloudfront update-distribution \
              --id ${{ secrets.PRODUCTION_DISTRIBUTION_ID }} \
              --distribution-config file://rollback-config.json \
              --if-match $CURRENT_ETAG
            
            # ë¡¤ë°± í›„ ìºì‹œ ë¬´íš¨í™”
            aws cloudfront create-invalidation \
              --distribution-id ${{ secrets.PRODUCTION_DISTRIBUTION_ID }} \
              --paths "/*"
            
            echo "âœ… Rollback completed - reverted to ${{ steps.target.outputs.current_color }}"
            echo "â³ Please wait 5-10 minutes for rollback to fully propagate"
          else
            echo "âš ï¸ Rollback configuration not available"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "===================="

          if [[ "${{ job.status }}" == "success" ]]; then
            echo "ğŸ‰ Blue-Green deployment completed successfully!"
            echo "âœ… Target: ${{ steps.target.outputs.target_color }}"
            echo "âœ… Bucket: ${{ steps.target.outputs.target_bucket }}"
            echo "âœ… All health checks passed"
            echo "âœ… HTML rendering validated"
            echo "âœ… Lighthouse audit completed"
            echo "ğŸŒ Live URL: https://prod.min71.dev"
          else
            echo "âŒ Deployment failed!"
            echo "ğŸ”„ Rollback to ${{ steps.target.outputs.current_color }} initiated"
            echo "ğŸ“‹ Please check the logs above for failure details"
          fi

          echo "ğŸ“… Deployment Time: $(date)"
          echo "ğŸ·ï¸ Status: ${{ job.status }}"
